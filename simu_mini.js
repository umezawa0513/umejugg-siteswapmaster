class ClubRot{constructor(){this.list=[],this.clubRotSetting=document.getElementById("clubRotSetting"),this.clubRotSetting.innerHTML=""}displayInput(){this.clubRotSetting.style.display="block"}hiddenInput(){this.clubRotSetting.style.display="none"}createInput(t){this.clubRotSetting.innerHTML="",this.clubRotSetting.innerHTML="<p>クラブの回転数を変更できます</p>",this.list=[];let e=[];if(t.isAsync)for(let a of t.data)if(Array.isArray(a.num))for(let s=0;s<a.num.length;s++)e.push({text:SiteswapProcessor.CONVERT[a.num[s]],num:a.num[s]});else e.push({text:SiteswapProcessor.CONVERT[a.num],num:a.num});else for(let i of t.data)if(Array.isArray(i.numObj))for(let n of i.numObj)e.push({text:SiteswapProcessor.CONVERT[n.num]+(n.isCross?"x":""),num:n.num});else e.push({text:SiteswapProcessor.CONVERT[i.numObj.num]+(i.numObj.isCross?"x":""),num:i.numObj.num});for(let r=0;r<e.length;r++){let l=document.createElement("span"),o=document.createElement("select");o.id="clubRotSelector"+r,o.classList.add("clubSelectBox");let h=document.createElement("label");h.textContent=e[r].text,h.setAttribute("for",o.id);for(var c=0;c<=30;c++){var u=document.createElement("option");if(u.value=c,u.text=c,o.appendChild(u),2==e[r].num||0==e[r].num)break}o.value=Math.floor(e[r].num/2),this.list.push(o.value),o.setAttribute("data-index",r),l.appendChild(h),l.appendChild(o),this.clubRotSetting.appendChild(l)}}changeList(t,e){var a=document.querySelectorAll("[data-index='"+e+"']");if(a.length>0){var s=a[0].value;this.list[e]=s}}getRot(t){return this.list[t]}}class RingSetting{constructor(){this.list=[],this.ringSetting=document.getElementById("ringSetting"),this.ringSetting.innerHTML="",this.optionList=["ノーマル","フラット","アウター","パンケーキ"]}displayInput(){this.ringSetting.style.display="block"}hiddenInput(){this.ringSetting.style.display="none"}createInput(t){this.ringSetting.innerHTML="",this.ringSetting.innerHTML="<p>リングの投げ方を変更できます</p>",this.list=[];let e=[];if(t.isAsync)for(let a of t.data)if(Array.isArray(a.num))for(let s=0;s<a.num.length;s++)e.push({text:SiteswapProcessor.CONVERT[a.num[s]],num:a.num[s],prefix:a.prefix});else e.push({text:SiteswapProcessor.CONVERT[a.num],num:a.num,prefix:a.prefix});else for(let i of t.data)if(Array.isArray(i.numObj))for(let n of i.numObj)e.push({text:SiteswapProcessor.CONVERT[n.num]+(n.isCross?"x":""),num:n.num,prefix:i.prefix});else e.push({text:SiteswapProcessor.CONVERT[i.numObj.num]+(i.numObj.isCross?"x":""),num:i.numObj.num,prefix:i.prefix});for(let r=0;r<e.length;r++){let l=document.createElement("span"),o=document.createElement("select");o.id="ringSelector"+r,o.classList.add("singSelectBox");let h=document.createElement("label");h.textContent=e[r].text,h.setAttribute("for",o.id);for(let c=0;c<this.optionList.length&&0!=e[r].num;c++){var u=document.createElement("option");u.value=c,u.text=this.optionList[c],o.appendChild(u)}o.value="/"==e[r].prefix?2:0,this.list.push("/"==e[r].prefix?2:0),o.setAttribute("data-index-ring",r),l.appendChild(h),l.appendChild(o),this.ringSetting.appendChild(l)}}changeList(t,e){var a=document.querySelectorAll("[data-index-ring='"+e+"']");if(a.length>0){var s=a[0].value;this.list[e]=s}}getSetting(t){return this.list[t]}}class Display{constructor(){this.er=document.getElementById("er"),this.saitoprint=document.getElementById("saitoprint"),this.input=document.getElementById("skaku")}init(){this.er.value="",this.saitoprint.value=""}update(t,e,a){this.er.value=null===t?"":t,this.saitoprint.value=a?e:"",this.input.classList.toggle("error-border",e&&!a)}}class Pattern{constructor(){this.isAsync=null,this.data=[],this.maxHeight=0}setData(t,e,a){this.isAsync=t,this.data=e,this.maxHeight=a}}class Data{constructor(t,e,a,s,i,n,r,l){this.num=t,this.xs=e,this.xg=a,this.x=s,this.y=i,this.isCross=n,this.index=r,this.rot=0}}class HandData extends Data{constructor(t,e,a,s,i,n,r,l=""){super(t,e,a,s,i,n,r),this.where=l}}class SiteswapProcessor{static VALID_THROW_CHARS={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,b:11,c:12,d:13,e:14,f:15,g:16,h:17,i:18,j:19,k:20,l:21,m:22,n:23,o:24,p:25,q:26,r:27,s:28,t:29,u:30,v:31,w:32,x:33,y:34,z:35,A:10,B:11,C:12,D:13,E:14,F:15,G:16,H:17,I:18,J:19,K:20,L:21,M:22,N:23,O:24,P:25,Q:26,R:27,S:28,T:29,U:30,V:31,W:32,X:33,Y:34,Z:35,"-":"-","/":"/","+":"+","(":"(",",":",",")":")","[":"[","]":"]","*":"*"};static CONVERT={0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",10:"a",11:"b",12:"c",13:"d",14:"e",15:"f",16:"g",17:"h",18:"i",19:"j",20:"k",21:"l",22:"m",23:"n",24:"o",25:"p",26:"q",27:"r",28:"s",29:"t",30:"u",31:"v",32:"w",33:"x",34:"y",35:"z"};constructor(){this.isValidated=!1,this.isJugglable=!1,this.pattern=null,this.patternData=new Pattern}_result(t,e,a){return this.isValidated=t,this.isJugglable=e,{isValid:t,isJugglable:e,message:a}}validate(t){return(this.pattern=t.replace(/\s+/g,""),this.pattern)?this.pattern.includes("(")||this.pattern.includes(",")||this.pattern.includes(")")||this.pattern.includes("*")?this._validateSyncPattern(this.pattern):this._validateAsyncPattern(this.pattern):this._result(!1,!1,null)}_hasKey(t){return t.split("").every(t=>SiteswapProcessor.VALID_THROW_CHARS.hasOwnProperty(t))}_validateAsyncPattern(t){if(!this._hasKey(t))return this._result(!1,!1,"使用できない文字が含まれています");let e=!1,a=null,s=!1,i=[],n=[],r=[],l=0,o=[];for(let h of t)if("-"===h||"/"===h||"+"===h){if(e)return this._result(!1,!1,"接頭辞が重複しています");if(s)return this._result(!1,!1,"接頭辞は[]の外に記入してください");e=!0,a=h}else if("["===h){if(s)return this._result(!1,!1,"'['が重複しています");s=!0}else if("]"===h){if(!s)return this._result(!1,!1,"'['が見つかりません");if(!i.length)return this._result(!1,!1,"'[]'の中身が存在しません");e?(n.push({prefix:a,num:i,index:o}),e=!1,a=null):n.push({prefix:"#",num:i,index:o}),r.push(i),s=!1,i=[],o=[]}else e?s?(i.push(SiteswapProcessor.VALID_THROW_CHARS[h]),o.push(l)):(n.push({prefix:a,num:SiteswapProcessor.VALID_THROW_CHARS[h],index:l}),r.push(SiteswapProcessor.VALID_THROW_CHARS[h]),e=!1,a=null):s?(i.push(SiteswapProcessor.VALID_THROW_CHARS[h]),o.push(l)):(n.push({prefix:"#",num:SiteswapProcessor.VALID_THROW_CHARS[h],index:l}),r.push(SiteswapProcessor.VALID_THROW_CHARS[h])),l++;return s?this._result(!1,!1,"']'が見つかりません"):e?this._result(!1,!1,"接頭辞の後に数値が見つかりません"):n.length?(this.patternData.setData(!0,n,Math.max(...r.flat(1/0))),this._isJugglableAsync(r))?this._result(!0,!0,null):this._result(!0,!1,"この数列は投げられません"):this._result(!1,!1,null)}_isJugglableAsync(t){let e=[],a=[];for(let s=0;s<t.length;s++)if(Array.isArray(t[s]))for(let i of t[s])e.push((i+s+1)%t.length),a.push(s+1);else e.push((t[s]+s+1)%t.length),a.push(s+1);let n=t.length,r=e.map(t=>(t%n+n)%n),l=a.map(t=>(t%n+n)%n),o=r.sort((t,e)=>t-e),h=l.sort((t,e)=>t-e);return o.every((t,e)=>t===h[e])}_validateSyncPattern(t){if(!this._hasKey(t))return this._result(!1,!1,"使用できない文字が含まれています");let e=[],a=[],s=null,i=!!t.endsWith("*"),n=!1,r=0;if(t=t.endsWith("*")?t.slice(0,-1):t,!/^\([^,()]+,[^,()]+\)(?:\([^,()]+,[^,()]+\))*$/.test(t))return this._result(!1,!1,"シンクロの形式が正しくありません");if(i){let l=t.split(/\)\(/).map(t=>t.replace(/^\(|\)$/g,"").split(",")),o=l.map(([t,e])=>[e,t]);t=l.concat(o).map(([t,e])=>`(${t},${e})`).join("")}return([a,e,n,s,r]=this._validateSyncSection(t),n)?s:(this.patternData.setData(!1,e,r),this._isJugglableAsync(this._syncToAsync(a)))?this._result(!0,!0,null):this._result(!0,!1,"この数列は投げられません")}_validateSyncSection(t){let e=[],a=[],s=0,i=[];t=t.slice(1,-1);let n=t.split(/\)\(|,/);if(n.includes(""))return[[],[],!0,structuredClone(this._result(!1,!1,"括弧内に数値が存在しません1"))];for(let r of n){let l="#";if(r.includes("[")||r.includes("]")){if(["-","/","+"].includes(r[0])&&(l=r[0],r=r.slice(1)),!(r.startsWith("[")&&r.endsWith("]")))return[[],[],!0,structuredClone(this._result(!1,!1,"マルチの形式が正しくありません"))];if(!(r=r.slice(1,-1)).length)return[[],[],!0,structuredClone(this._result(!1,!1,"'[]'の中に数値が存在しません"))];let o=[...r].map(t=>SiteswapProcessor.VALID_THROW_CHARS[t]);if(!o.every(t=>Number.isInteger(t)))return[[],[],!0,structuredClone(this._result(!1,!1,"'[]'の中には数値またはクロス(x)のみ入力可能です"))];let h=r.toLowerCase().match(/[a-z0-9]x|[a-z0-9]/g),c=[];for(let u of h){if(SiteswapProcessor.VALID_THROW_CHARS[u[0]]%2!=0)return[[],[],!0,structuredClone(this._result(!1,!1,"シンクロサイトスワップでは奇数を使用できません"))];2==u.length?c.push({num:SiteswapProcessor.VALID_THROW_CHARS[u[0]],isCross:!0,index:s}):c.push({num:SiteswapProcessor.VALID_THROW_CHARS[u[0]],isCross:!1,index:s}),i.push(SiteswapProcessor.VALID_THROW_CHARS[u[0]]),s++}e.push({prefix:l,numObj:c}),a.push(c)}else{if(["-","/","+"].includes(r[0])){if(r.toLowerCase().endsWith("x")&&3!==r.length||!r.toLowerCase().endsWith("x")&&2!==r.length)return[[],[],!0,structuredClone(this._result(!1,!1,"括弧内のセクションが不正な形式です"))];if(!Number.isInteger(SiteswapProcessor.VALID_THROW_CHARS[r[1]]))return[[],[],!0,structuredClone(this._result(!1,!1,"括弧内に数値が存在しません2"))];if(SiteswapProcessor.VALID_THROW_CHARS[r[1]]%2!=0)return[[],[],!0,structuredClone(this._result(!1,!1,"シンクロサイトスワップでは奇数を使用できません"))];e.push({prefix:r[0],numObj:{num:SiteswapProcessor.VALID_THROW_CHARS[r[1]],isCross:r.toLowerCase().endsWith("x"),index:s}}),a.push({num:SiteswapProcessor.VALID_THROW_CHARS[r[1]],isCross:r.toLowerCase().endsWith("x")}),i.push(SiteswapProcessor.VALID_THROW_CHARS[r[1]])}else{if(r.toLowerCase().endsWith("x")&&2!==r.length||!r.toLowerCase().endsWith("x")&&1!==r.length)return[[],[],!0,structuredClone(this._result(!1,!1,"括弧内のセクションが不正な形式です"))];if(!Number.isInteger(SiteswapProcessor.VALID_THROW_CHARS[r[0]]))return[[],[],!0,structuredClone(this._result(!1,!1,"括弧内に数値が存在しません3"))];if(SiteswapProcessor.VALID_THROW_CHARS[r[0]]%2!=0)return[[],[],!0,structuredClone(this._result(!1,!1,"シンクロサイトスワップでは奇数を使用できません"))];e.push({prefix:"#",numObj:{num:SiteswapProcessor.VALID_THROW_CHARS[r[0]],isCross:r.toLowerCase().endsWith("x"),index:s}}),a.push({num:SiteswapProcessor.VALID_THROW_CHARS[r[0]],isCross:r.toLowerCase().endsWith("x")}),i.push(SiteswapProcessor.VALID_THROW_CHARS[r[0]])}s++}}return[a,e,!1,structuredClone(this._result(!0,!1,null)),Math.max(...i)]}_syncToAsync(t){let e=[];for(let a=0;a<t.length;a++){let s=t[a];if(this.isObject(s))s.isCross&&a%2==0?e.push(s.num+1):s.isCross&&a%2==1?e.push(s.num-1):e.push(s.num);else{let i=[];for(let n of s)n.isCross&&a%2==0?i.push(n.num+1):n.isCross&&a%2==1?i.push(n.num-1):i.push(n.num);e.push(i)}}return e}isObject=t=>null!==t&&"object"==typeof t&&!Array.isArray(t)}class DataProcessor{static createSimuData(t,e){if(t.isAsync){let a=t.data[e%t.data.length],s=a.num,i=a.prefix,n=t.data[(e+1)%t.data.length].prefix,r="+"==i||"#"==i,l=state.x[(e%2?0:2)+(e%2!=("+"==i||"/"==i)?1:0)],o=state.x[((e+1)%2?0:2)+((e+1)%2!=("+"==n||"/"==n)?1:0)];if(Array.isArray(s)){let h=[];for(let c=0;c<s.length;c++){let u=1==s[c]?o:this.categorize(e%2,s[c]%2,r);state.simuCatchData[s[c]]?(u=1==s[c]?o:state.simuCatchData[s[c]].xg,h.push(new Data(s[c],l,u,0,state.Y_INI,!1,a.index[c]))):(state.simuCatchData[s[c]]=new Data(s[c],l,u,0,state.Y_INI,!1,a.index[c]),h.push(new Data(s[c],l,u,0,state.Y_INI,!1,a.index[c])))}return h}{let d=1==s?o:this.categorize(e%2,s%2,r);return state.simuCatchData[s]?(d=1==s?o:state.simuCatchData[s].xg,[new Data(s,l,d,0,state.Y_INI,!1,a.index)]):(state.simuCatchData[s]=new Data(s,l,d,0,state.Y_INI,!1,a.index),[new Data(s,l,d,0,state.Y_INI,!1,a.index)])}}{let m=[t.data[e%t.data.length].numObj,t.data[(e+1)%t.data.length].numObj],p=[t.data[e%t.data.length].prefix,t.data[(e+1)%t.data.length].prefix],_=["+"==p[0]||"/"==p[0],"+"==p[1]||"/"==p[1]],x=["+"==p[0]||"#"==p[0],"+"==p[1]||"#"==p[1]],S=[state.x[_[0]?0:1],state.x[_[1]?3:2]],g=[];state.simuCatchData[1]&&(g=[state.simuCatchData[1][0]?state.simuCatchData[1][0]:state.x[0],state.simuCatchData[1][1]?state.simuCatchData[1][1]:state.x[4]]);let I=[];for(let $ of[0,1])if(Array.isArray(m[$])){let b=[];for(let y of m[$]){let f=y.isCross,D=this.categorizeSync($,f,x[$]);state.simuCatchData[y.num/2]&&(!state.simuCatchData[y.num/2]||state.simuCatchData[y.num/2][f?-($-1):$])?b.push(new Data(y.num,S[$],state.simuCatchData[y.num/2][f?-($-1):$].xg,0,state.Y_INI,f,y.index)):(state.simuCatchData[y.num/2]||(state.simuCatchData[y.num/2]=[]),state.simuCatchData[y.num/2][f?-($-1):$]=new Data(y.num,S[0],D,0,state.Y_INI,f,y.index),b.push(new Data(y.num,S[$],D,0,state.Y_INI,f,y.index)))}I.push(...b)}else{let P=m[$].isCross,C=this.categorizeSync($,P,x[$]);state.simuCatchData[m[$].num/2]&&(!state.simuCatchData[m[$].num/2]||state.simuCatchData[m[$].num/2][P?-($-1):$])?I.push(new Data(m[$].num,S[$],state.simuCatchData[m[$].num/2][P?-($-1):$].xg,0,state.Y_INI,P,m[$].index)):(state.simuCatchData[m[$].num/2]||(state.simuCatchData[m[$].num/2]=[]),state.simuCatchData[m[$].num/2][P?-($-1):$]=new Data(m[$].num,S[0],C,0,state.Y_INI,P,m[$].index),I.push(new Data(m[$].num,S[$],C,0,state.Y_INI,P,m[$].index)))}return I}}static categorize=(t,e,a)=>state.x[(t==e?2:0)+(t==e==a?1:0)];static categorizeSync=(t,e,a)=>state.x[(t==e?0:2)+(t!=e==a?1:0)];static createSimuGripData(t,e,a,s){if(e.isAsync){let i=e.data[a%e.data.length].num,n=e.data[a%e.data.length].index,r=e.data[a%e.data.length].prefix,l=state.x[(a%2?0:2)+(a%2!=("+"==r||"/"==r)?1:0)];return new Data(i,t.xg,l,0,state.Y_INI,!1,n)}{let o=[e.data[a%e.data.length].numObj,e.data[(a+1)%e.data.length].numObj],h=[e.data[a%e.data.length].prefix,e.data[(a+1)%e.data.length].prefix],c=["+"==h[0]||"/"==h[0],"+"==h[1]||"/"==h[1]],u=[state.x[c[0]?0:1],state.x[c[1]?3:2]];return new Data(o[s],t.xg,u[s],0,state.Y_INI,!1,o[s].index)}}static createSimuHandData(t,e,a,s,i,n){if(e.isAsync){let r=e.data[a%e.data.length].num,l=e.data[a%e.data.length].index,o=e.data[a%e.data.length].prefix,h=state.x[(a%2?0:2)+(a%2!=("+"==o||"/"==o)?1:0)],c=t?1==t.num?state.x[a%2?0:3]:t.xg:state.x[a%2?0:3];a-=1;let u=e.data[a%e.data.length].num,d=e.data[a%e.data.length].index,m=e.data[a%e.data.length].prefix,p=state.x[(a%2?0:2)+(a%2!=("+"==m||"/"==m)?1:0)],_=s?s.xg:state.x[a%2?0:3];return[new HandData(r,c,h,0,state.Y_INI,!1,l,a%2?"LD":"RD"),new HandData(u,p,_,0,state.Y_INI,!1,d,a%2?"RU":"LU")]}{if(n){let x=[e.data[a%e.data.length].numObj,e.data[(a+1)%e.data.length].numObj],S=[e.data[a%e.data.length].prefix,e.data[(a+1)%e.data.length].prefix],g=["+"==S[0]||"/"==S[0],"+"==S[1]||"/"==S[1]],I=[state.x[g[0]?0:1],state.x[g[1]?3:2]],$=t[1]&&t[1][i]?t[1][i].xg:state.x[i?3:0];return new HandData(x[i],I[i],$,0,state.Y_INI,!1,x[i].index,i?"LU":"RU")}let b=[e.data[a%e.data.length].numObj,e.data[(a+1)%e.data.length].numObj],y=[e.data[a%e.data.length].prefix,e.data[(a+1)%e.data.length].prefix],f=["+"==y[0]||"/"==y[0],"+"==y[1]||"/"==y[1]],D=[state.x[f[0]?0:1],state.x[f[1]?3:2]],P=t[1]&&t[1][i]?t[1][i].xg:state.x[i?3:0];return new HandData(b[i],P,D[i],0,state.Y_INI,!1,b[i].index,i?"LD":"RD")}}}class State{constructor(){this.Y_INI=400,this.G_INI=10,this.maxh=30,this.x=[null,null,null,null],this.x3mag=null,this.x4mag=null,this.maxnum=null,this.maxHPa=null,this.ballSize=null,this.isValidated=!1,this.isJugglable=!1,this.pattern=null,this.patternData=null,this.objectColor=document.querySelector("#syousaisettei2").value,this.playerColor=document.querySelector("#syousaisettei3").value,this.playerhidden=document.querySelector("#syousaisettei4").checked,this.texthidden=!document.querySelector("#syousaisettei6").checked,this.isNotStopWhenMovCam=document.querySelector("#isNotStopWhenMovCam").checked,this.viewSpeed=document.querySelector("#syousaisettei5").value/10,this.objectselect=document.querySelector("#syousaisettei8").value,this.clubRot=new ClubRot,this.ringSetting=new RingSetting,this.simuData=[],this.simuCatchData=[],this.simuHandData=[],this.simuGripData=[],this.centerX=width/2,this.camPosZ=-(30*(width/2)),this.camPosX=-document.getElementById("camera-x").value/100}setData(t){console.log(JSON.stringify(t)),this.isValidated=t.isValidated,this.isJugglable=t.isJugglable,this.pattern=t.pattern,this.patternData=t.patternData}createIniAnimeData(){this.clubRot.createInput(this.patternData),this.ringSetting.createInput(this.patternData),this.maxnum=this.patternData.maxHeight,this.x[1]=Math.floor(width/2-170/(this.maxnum>=5?this.maxnum:5)),this.x[2]=Math.floor(width/2+170/(this.maxnum>=5?this.maxnum:5)),this.x[3]=Math.floor((this.x[2]-width/2)*1.5+this.x[2]),this.x[0]=Math.floor(this.x[1]-(this.x[2]-width/2)*1.5),this.maxHPa=this.G_INI*(this.maxnum>=5?this.maxnum:5)**2/(this.Y_INI-this.maxh),this.x3mag=width/2+170/(this.maxnum>=5?this.maxnum:5),this.x4mag=(this.x3mag-width/2)*1.5+this.x[2],this.ballSize=this.maxnum>=5?80/this.maxnum:16,this.lineSize=(this.x4mag-this.x3mag)/5,this.bodySize=this.x4mag-this.x3mag,ctx.fillStyle=this.objectColor,ctx.lineWidth=this.lineSize}setViewSpeed(){this.viewSpeed=document.querySelector("#syousaisettei5").value/10}setZeroViewSpeed(){this.viewSpeed=0}}class Animation{constructor(){this.frame=this.frame.bind(this)}init(){this.lastTime=null,this.count=0,this.sumTime=1,this.lastSumTime=0,this.diffTime=0}start(t){this.init(),display.init(),state=new State;let e=new SiteswapProcessor,a=e.validate(t);display.update(a.message,t,a.isJugglable),state.setData(e),state.isJugglable?(state.createIniAnimeData(),log.timeStart(t)):log.timeClear()}frame(t){if(ctx.clearRect(0,0,width,height),state.isJugglable){this.lastTime||(this.lastTime=t);let e=(t-this.lastTime)/1e3;this.lastTime=t;for(let a=0;a<state.simuData.length;a++)state.simuData[a].y>state.Y_INI&&state.simuData.splice(a,1);for(let s=0;s<state.simuGripData.length;s++)state.simuGripData[s].y<state.Y_INI&&state.simuGripData.splice(s,1);let i=[];for(let n=0;n<state.simuHandData.length;n++)(state.simuHandData[n].y>=state.Y_INI&&"RU"!=state.simuHandData[n].where&&"LU"!=state.simuHandData[n].where||state.simuHandData[n].y<=state.Y_INI&&"RD"!=state.simuHandData[n].where&&"LD"!=state.simuHandData[n].where)&&i.push(state.simuHandData[n]);state.simuHandData=i,draw.playerBody();for(let r=0;r<state.simuHandData.length;r++)draw.player(state.simuHandData[r],e,r);for(let l=0;l<state.simuData.length;l++)"ball"==state.objectselect?draw.addBall(state.simuData[l],e,state.ballSize,l):"ring"==state.objectselect?draw.addRing(state.simuData[l],e,state.ballSize,l):"club"==state.objectselect&&draw.addClub(state.simuData[l],e,state.ballSize,l);for(let o=0;o<state.simuGripData.length;o++)"ball"==state.objectselect?draw.addBallHand(state.simuGripData[o],e,state.ballSize,o):"ring"==state.objectselect?draw.addRingHand(state.simuGripData[o],e,state.ballSize,o):"club"==state.objectselect&&draw.addClubHand(state.simuGripData[o],e,state.ballSize,o);if(this.sumTime+=e*state.viewSpeed,this.sumTime-this.lastSumTime>1){if(state.patternData.isAsync)state.simuCatchData.shift(),state.simuData.push(...DataProcessor.createSimuData(state.patternData,this.count).filter(t=>0!==t.num)),state.simuCatchData[1]&&1!=state.simuCatchData[1].num&&state.simuGripData.push(DataProcessor.createSimuGripData(state.simuCatchData[1],state.patternData,this.count+1)),state.simuHandData.push(...DataProcessor.createSimuHandData(state.simuCatchData[1],state.patternData,this.count+1,state.simuCatchData[2]));else if(this.count%2)for(let h of[0,1])state.simuCatchData[1]&&state.simuCatchData[1][h]&&state.simuGripData.push(DataProcessor.createSimuGripData(state.simuCatchData[1][h],state.patternData,this.count+1,h)),state.simuHandData.push(DataProcessor.createSimuHandData(state.simuCatchData,state.patternData,this.count+1,state.simuCatchData,h));else for(let c of(state.simuCatchData.shift(),state.simuData.push(...DataProcessor.createSimuData(state.patternData,this.count).filter(t=>0!==t.num)),[0,1]))state.simuHandData.push(DataProcessor.createSimuHandData(state.simuCatchData,state.patternData,this.count,state.simuCatchData,c,!0));this.count+=1,this.diffTime=this.sumTime-this.lastSumTime,this.lastSumTime=this.sumTime}}requestAnimationFrame(this.frame)}}class Draw{constructor(){this.clubShape=[3,.29,1.6,-.3,.4,1.8,.6,2.75,.35,2.9,.12,2.5,.28,1.8,.62,1.2,2.3,.5,1.25,.5,.8,.4],this.body_z=[1.2,1.6]}addBall(t,e,a,s){let i=t.num-1,n=t.xg,r=t.xs;r==n&&(n+=.1);let l=n-r,o=state.G_INI,h=r+t.x,c;c=1==t.num?l/1:l/(i*animation.diffTime);let u=state.Y_INI-o*(i+1)**2/state.maxHPa;2==t.num&&(u=state.Y_INI-o*(i+25.5/state.bodySize)**2/state.maxHPa),h+=c*e*state.viewSpeed;let d=(r+n)/2,m=(u-state.Y_INI)/((d-r)*(d-n))*(h-r)*(h-n)+state.Y_INI;m<=state.Y_INI+1&&(ctx.beginPath(),ctx.arc(camera.projectToScreenX(h,0),m,a*camera.getSizeRatio(h),0,2*Math.PI),ctx.fill(),state.texthidden||(ctx.font="30px serif",ctx.fillText(String(SiteswapProcessor.CONVERT[t.num])+(t.isCross?"x":""),camera.projectToScreenX(h,0)+a*(1+.1*Math.abs(state.camPosX)),m))),state.simuData[s].x=h-r,state.simuData[s].y=m}addBallHand(t,e,a,s){let i=t.xg,n=t.xs;n==i&&(i+=.1);let r=i-n,l=state.G_INI,o=n+t.x,h=r/(1*animation.diffTime),c=state.Y_INI-l*(1+25.5/state.bodySize)**2/state.maxHPa;o+=h*e*state.viewSpeed;let u=(n+i)/2,d=-((c-state.Y_INI)/((u-n)*(u-i)))*(o-n)*(o-i)+state.Y_INI;ctx.beginPath(),ctx.arc(camera.projectToScreenX(o,0),d,a*camera.getSizeRatio(o),0,2*Math.PI),ctx.fill(),state.simuGripData[s].x=o-n,state.simuGripData[s].y=d}ring(t,e,a,s,i,n=0){function r(t,e,a){let s=[0,0*Math.cos(e)-1*Math.sin(e),0*Math.sin(e)+1*Math.cos(e)],i=[s[0]*Math.cos(a)+s[2]*Math.sin(a),s[1],-s[0]*Math.sin(a)+s[2]*Math.cos(a)],n=Math.abs(i[2]),r=Math.atan2(i[1],i[0]);return 1e-10>Math.abs(i[0])&&1e-10>Math.abs(i[1])&&(r=0),{majorAxis:t,minorAxis:t*n,rotationAngle:r}}let l=Math.abs(Math.sin(Math.PI*state.camPosX/2+n)),o=r(2.3*a,Math.PI*i/2,Math.PI*state.camPosX/2+Math.PI/2+n),h=r(1.7*a,Math.PI*i/2,Math.PI*state.camPosX/2+Math.PI/2+n);ctx.strokeStyle=state.objectColor,ctx.lineWidth=.2*a,ctx.beginPath(),ctx.ellipse(t,e,o.minorAxis,o.majorAxis,o.rotationAngle,0,2*Math.PI),ctx.stroke(),ctx.lineWidth=.1*a,ctx.beginPath(),ctx.ellipse(t-.1*a*(1-l),e,h.minorAxis,h.majorAxis,h.rotationAngle,0,2*Math.PI),ctx.ellipse(t-.1*a*(1-l),e,o.minorAxis,o.majorAxis,o.rotationAngle,0,2*Math.PI,!0),ctx.fill(),ctx.beginPath(),ctx.ellipse(t+.1*a*(1-l),e,h.minorAxis,h.majorAxis,h.rotationAngle,0,2*Math.PI),ctx.ellipse(t+.1*a*(1-l),e,o.minorAxis,o.majorAxis,o.rotationAngle,0,2*Math.PI,!0),ctx.fill(),ctx.strokeStyle=state.playerColor,ctx.lineWidth=state.lineSize}addRing(t,e,a,s){let i=t.num-1,n=t.xg,r=t.xs;r==n&&(n+=.1);let l=n-r,o=state.G_INI,h=r+t.x,c;c=1==t.num?l/1:l/(i*animation.diffTime);let u=state.Y_INI-o*(i+1)**2/state.maxHPa;2==t.num&&(u=state.Y_INI-o*(i+25.5/state.bodySize)**2/state.maxHPa),h+=c*e*state.viewSpeed;let d=(r+n)/2,m=(u-state.Y_INI)/((d-r)*(d-n))*(h-r)*(h-n)+state.Y_INI,p=state.ringSetting.getSetting(t.index),_,x=t.rot;_=1==t.num?0:2*t.num/(i*animation.diffTime);let S=-(.5*Math.tanh((n-r)/(state.Y_INI-u)));if(n==r&&(S=0),S=Math.max(Math.min(S,.1),-.1),m<=state.Y_INI+1){if(0==p)this.ring(camera.projectToScreenX(h,-(1.2*a)),m,a,2==t.num,S,0),state.texthidden||(ctx.font="30px serif",ctx.fillText(String(SiteswapProcessor.CONVERT[t.num])+(t.isCross?"x":""),camera.projectToScreenX(h,-(1.2*a))+a*(1+2*Math.abs(Math.sin(Math.PI*state.camPosX/2))),m));else if(1==p)S=1,this.ring(camera.projectToScreenX(h,-(1.2*a)),m,a,2==t.num,S,0),state.texthidden||(ctx.font="30px serif",ctx.fillText(String(SiteswapProcessor.CONVERT[t.num])+(t.isCross?"x":""),camera.projectToScreenX(h,-(1.2*a))+a*(1+2*Math.abs(Math.sin(Math.PI/2))),m));else if(2==p){S=0;let g=2*a*(1-t.x/l)-a;this.ring(camera.projectToScreenX(h,g),m,a,2==t.num,S,Math.PI/2),state.texthidden||(ctx.font="30px serif",ctx.fillText(String(SiteswapProcessor.CONVERT[t.num])+(t.isCross?"x":""),camera.projectToScreenX(h,g)+a*(1+2*Math.abs(Math.sin(Math.PI*(1-state.camPosX)/2))),m))}else 3!=p||(x+=_*e*state.viewSpeed,this.ring(camera.projectToScreenX(h,-(1.2*a)),m,a,2==t.num,-x+1,Math.PI/2),state.texthidden||(ctx.font="30px serif",ctx.fillText(String(SiteswapProcessor.CONVERT[t.num])+(t.isCross?"x":""),camera.projectToScreenX(h,-(1.2*a))+a*(1+2*Math.abs(Math.sin(Math.PI/2))),m)))}state.simuData[s].x=h-r,state.simuData[s].y=m,state.simuData[s].rot=x}addRingHand(t,e,a,s){let i=t.xg,n=t.xs;n==i&&(i+=.1);let r=i-n,l=state.G_INI,o=n+t.x,h=r/(1*animation.diffTime),c=state.Y_INI-l*(1+25.5/state.bodySize)**2/state.maxHPa;o+=h*e*state.viewSpeed;let u=(n+i)/2,d=-((c-state.Y_INI)/((u-n)*(u-i)))*(o-n)*(o-i)+state.Y_INI,m=state.ringSetting.getSetting(t.index);if(0==m)this.ring(camera.projectToScreenX(o,-(1.2*a)),d,a,!0,0,0);else if(1==m){let p=-(state.Y_INI-d)/(6*Math.pow(a,.8))+1;this.ring(camera.projectToScreenX(o,-(1.2*a)),d-(state.Y_INI-d)/3,a,!0,p,Math.PI/2)}else if(2==m)this.ring(camera.projectToScreenX(o,0),d,a,!0,0,Math.PI/2);else if(3==m){let _=-(state.Y_INI-d)/(6*Math.pow(a,.8))+1;this.ring(camera.projectToScreenX(o,-(1.2*a)),d-(state.Y_INI-d)/3,a,!0,_,Math.PI/2)}state.simuGripData[s].x=o-n,state.simuGripData[s].y=d}club(t,e,a,s,i,n){a+=.5;let r=Math.sin(Math.PI*n/2);i&&(a=(state.Y_INI-e)/(19*Math.pow(s,.8))+.5,state.Y_INI-e>0&&(a=(state.Y_INI-e)/(50*Math.pow(s,.8))+.5),r=-Math.sin(Math.PI*state.camPosX/2),e-=Math.pow(s,.8)*Math.sin(2*Math.PI*(a+.5))*3),ctx.lineWidth=5*state.lineSize/8;let l=Math.sqrt(Math.sin(2*Math.PI*a)*Math.sin(2*Math.PI*a)+r*r*Math.cos(2*Math.PI*a)*Math.cos(2*Math.PI*a)),o=Math.atan2(Math.sin(2*Math.PI*a),r*Math.cos(2*Math.PI*a));ctx.beginPath(),ctx.ellipse(t+s*this.clubShape[13]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[13]*Math.sin(2*Math.PI*a),s*this.clubShape[14],s*this.clubShape[15]*l,o+Math.PI/2,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(t-s*this.clubShape[0]*r*Math.cos(2*Math.PI*a),e-s*this.clubShape[0]*Math.sin(2*Math.PI*a),s*this.clubShape[1],0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.moveTo(t+s*this.clubShape[2]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[2]*Math.sin(2*Math.PI*a)),ctx.lineTo(t-s*this.clubShape[0]*r*Math.cos(2*Math.PI*a),e-s*this.clubShape[0]*Math.sin(2*Math.PI*a)),ctx.stroke(),ctx.beginPath(),ctx.moveTo(t+s*this.clubShape[2]*r*Math.cos(2*Math.PI*a)+this.clubShape[4]*s*Math.sin(2*Math.PI*a)/l,e+s*this.clubShape[2]*Math.sin(2*Math.PI*a)+-(this.clubShape[4]*s*r)*Math.cos(2*Math.PI*a)/l),ctx.lineTo(t+s*this.clubShape[3]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[3]*Math.sin(2*Math.PI*a)),ctx.lineTo(t+s*this.clubShape[2]*r*Math.cos(2*Math.PI*a)-this.clubShape[4]*s*Math.sin(2*Math.PI*a)/l,e+s*this.clubShape[2]*Math.sin(2*Math.PI*a)- -(this.clubShape[4]*s*r)*Math.cos(2*Math.PI*a)/l),ctx.stroke(),ctx.beginPath(),ctx.moveTo(t+s*this.clubShape[11]*r*Math.cos(2*Math.PI*a)-this.clubShape[12]*s*Math.sin(2*Math.PI*a)/l,e+s*this.clubShape[11]*Math.sin(2*Math.PI*a)- -(this.clubShape[12]*s*r)*Math.cos(2*Math.PI*a)/l),ctx.lineTo(t+s*this.clubShape[9]*r*Math.cos(2*Math.PI*a)-this.clubShape[10]*s*Math.sin(2*Math.PI*a)/l,e+s*this.clubShape[9]*Math.sin(2*Math.PI*a)- -(this.clubShape[10]*s*r)*Math.cos(2*Math.PI*a)/l),ctx.lineTo(t+s*this.clubShape[9]*r*Math.cos(2*Math.PI*a)+this.clubShape[10]*s*Math.sin(2*Math.PI*a)/l,e+s*this.clubShape[9]*Math.sin(2*Math.PI*a)+-(this.clubShape[10]*s*r)*Math.cos(2*Math.PI*a)/l),ctx.lineTo(t+s*this.clubShape[11]*r*Math.cos(2*Math.PI*a)+this.clubShape[12]*s*Math.sin(2*Math.PI*a)/l,e+s*this.clubShape[11]*Math.sin(2*Math.PI*a)+-(this.clubShape[12]*s*r)*Math.cos(2*Math.PI*a)/l),ctx.stroke(),ctx.beginPath(),ctx.arc(t+s*this.clubShape[7]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[7]*Math.sin(2*Math.PI*a),s*this.clubShape[8],0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(t+s*this.clubShape[16]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[16]*Math.sin(2*Math.PI*a),s*this.clubShape[17],0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(t+s*this.clubShape[5]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[5]*Math.sin(2*Math.PI*a),s*this.clubShape[6],0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(t+s*this.clubShape[18]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[18]*Math.sin(2*Math.PI*a),s*this.clubShape[19],0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(t+s*this.clubShape[20]*r*Math.cos(2*Math.PI*a),e+s*this.clubShape[20]*Math.sin(2*Math.PI*a),s*this.clubShape[21],0,2*Math.PI),ctx.fill(),ctx.lineWidth=state.lineSize}addClub(t,e,a,s){let i=t.num-1,n=t.xg,r=t.xs;r==n&&(n+=.1);let l=n-r,o=state.G_INI,h=r+t.x,c=t.rot,u;u=1==t.num?l/1:l/(i*animation.diffTime);let d=state.Y_INI-o*(i+1)**2/state.maxHPa;2==t.num&&(d=state.Y_INI-o*(i+25.5/state.bodySize)**2/state.maxHPa),h+=u*e*state.viewSpeed;let m=(r+n)/2,p=(d-state.Y_INI)/((m-r)*(m-n))*(h-r)*(h-n)+state.Y_INI,_=state.clubRot.getRot(t.index),x;c+=(x=1==t.num?_/1:_/(i*animation.diffTime))*e*state.viewSpeed;let S=-Math.tanh((n-r)/(state.Y_INI-d));S=Math.max(Math.min(S,.2),-.2)-state.camPosX,p<=state.Y_INI+1&&(ctx.beginPath(),ctx.strokeStyle=state.objectColor,this.club(camera.projectToScreenX(h,-a),p,c,a,2==t.num,S),ctx.strokeStyle=state.playerColor,state.texthidden||(ctx.font="30px serif",ctx.fillText(String(SiteswapProcessor.CONVERT[t.num])+(t.isCross?"x":""),camera.projectToScreenX(h,-(.7*a))+a*(1+2*Math.abs(Math.sin(Math.PI*S/2))),p))),state.simuData[s].x=h-r,state.simuData[s].y=p,state.simuData[s].rot=c}addClubHand(t,e,a,s){let i=t.xg,n=t.xs;n==i&&(i+=.1);let r=i-n,l=state.G_INI,o=n+t.x,h=r/(1*animation.diffTime),c=state.Y_INI-l*(1+25.5/state.bodySize)**2/state.maxHPa;o+=h*e*state.viewSpeed;let u=(n+i)/2,d=-((c-state.Y_INI)/((u-n)*(u-i)))*(o-n)*(o-i)+state.Y_INI;ctx.beginPath(),ctx.strokeStyle=state.objectColor,this.club(camera.projectToScreenX(o,-a),d,0,a,!0,0),ctx.strokeStyle=state.playerColor,state.simuGripData[s].x=o-n,state.simuGripData[s].y=d}player(t,e,a){let s,i,n=t.xg,r=t.xs;switch(t.where){case"RU":s=1,i=-1;break;case"RD":s=-1,i=-1;break;case"LU":s=1,i=1;break;case"LD":s=-1,i=1;break;default:console.log("バグ")}r==n&&(n+=.1);let l=n-r,o=state.G_INI,h=r+t.x,c=l/(1*animation.diffTime),u=state.Y_INI-o*(1+25.5/state.bodySize)**2/state.maxHPa;h+=c*e*state.viewSpeed;let d=(r+n)/2,m=s*((u-state.Y_INI)/((d-r)*(d-n)))*(h-r)*(h-n)+state.Y_INI;state.playerhidden||(ctx.lineWidth=state.lineSize*camera.getSizeRatio(h),ctx.beginPath(),ctx.moveTo(camera.projectToScreenX(h,0),m),ctx.lineTo(camera.projectToScreenX(width/2+i*state.bodySize/.9-(h-width/2)/5,state.bodySize*this.body_z[0]),state.Y_INI-state.bodySize/1.7+(m-state.Y_INI)/7),ctx.stroke(),ctx.beginPath(),ctx.moveTo(camera.projectToScreenX(width/2+i*state.bodySize/.9-(h-width/2)/5,state.bodySize*this.body_z[0]),state.Y_INI-state.bodySize/1.7+(m-state.Y_INI)/7),ctx.lineTo(camera.projectToScreenX(width/2+i*state.bodySize/2,state.bodySize*this.body_z[1]),state.Y_INI-1.6*state.bodySize),ctx.lineTo(camera.projectToScreenX(width/2+i*state.bodySize/12,state.bodySize*this.body_z[1]),state.Y_INI-1.7*state.bodySize),ctx.stroke(),ctx.beginPath(),ctx.fillStyle=state.playerColor,ctx.fill(),ctx.arc(camera.projectToScreenX(width/2+i*state.bodySize/.9-(h-width/2)/5,state.bodySize*this.body_z[0]),state.Y_INI-state.bodySize/1.7+(m-state.Y_INI)/7,.113*state.bodySize,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.fill(),ctx.beginPath(),ctx.fill(),ctx.fillStyle=state.objectColor,ctx.lineWidth=state.lineSize),state.simuHandData[a].x=h-r,state.simuHandData[a].y=m}playerBody(){state.playerhidden||(ctx.strokeStyle=state.playerColor,ctx.beginPath(),ctx.arc(camera.projectToScreenX(width/2,state.bodySize*this.body_z[1]),state.Y_INI-2.5*state.bodySize+state.bodySize/6,state.bodySize/1.5-state.bodySize/6,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.moveTo(camera.projectToScreenX(width/2,state.bodySize*this.body_z[1]),state.Y_INI-2.5*state.bodySize+state.bodySize/1.5),ctx.lineTo(camera.projectToScreenX(width/2,state.bodySize*this.body_z[1]),state.Y_INI),ctx.lineTo(camera.projectToScreenX(width/2+.4*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize/2),ctx.lineTo(camera.projectToScreenX(width/2+.7*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize),ctx.lineTo(camera.projectToScreenX(width/2+.6*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize),ctx.lineTo(camera.projectToScreenX(width/2+.4*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize/2),ctx.stroke(),ctx.beginPath(),ctx.moveTo(camera.projectToScreenX(width/2,state.bodySize*this.body_z[1]),state.Y_INI),ctx.lineTo(camera.projectToScreenX(width/2-.4*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize/2),ctx.lineTo(camera.projectToScreenX(width/2-.7*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize),ctx.lineTo(camera.projectToScreenX(width/2-.6*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize),ctx.lineTo(camera.projectToScreenX(width/2-.4*state.bodySize,state.bodySize*this.body_z[1]),state.Y_INI+3*state.bodySize/2),ctx.stroke(),ctx.fillStyle=state.objectColor)}}class EventManager{constructor(){this.inputString=document.getElementById("skaku"),this.button=document.getElementById("kakuninbtn"),this.clubRotSetting=document.getElementById("clubRotSetting"),this.ringSetting=document.getElementById("ringSetting"),this.syousaisettei1=document.querySelector("#syousaisettei1"),this.syousaisettei2=document.querySelector("#syousaisettei2"),this.syousaisettei3=document.querySelector("#syousaisettei3"),this.syousaisettei4=document.querySelector("#syousaisettei4"),this.syousaisettei5=document.querySelector("#syousaisettei5"),this.syousaisettei6=document.querySelector("#syousaisettei6"),this.syousaisettei8=document.querySelector("#syousaisettei8"),this.isNotStopWhenMovCam=document.getElementById("isNotStopWhenMovCam"),this.cameraX=document.getElementById("camera-x"),this.setupEventListeners()}setupEventListeners(){this.button.addEventListener("click",t=>{t.preventDefault(),animation.start(this.inputString.value),log.timeClear(),log.add(this.inputString.value)}),this.inputString.addEventListener("input",()=>{animation.start(this.inputString.value)},!1),this.clubRotSetting.addEventListener("change",t=>{state.clubRot.changeList(t,t.target.dataset.index)},!1),this.ringSetting.addEventListener("change",t=>{state.ringSetting.changeList(t,t.target.dataset.indexRing)},!1),this.syousaisettei1.addEventListener("input",t=>{canvas.style.backgroundColor=t.target.value},!1),this.syousaisettei2.addEventListener("input",t=>{state.objectColor=t.target.value},!1),this.syousaisettei3.addEventListener("input",t=>{state.playerColor=t.target.value},!1),this.syousaisettei4.addEventListener("change",t=>{state.playerhidden=this.syousaisettei4.checked},!1),this.isNotStopWhenMovCam.addEventListener("change",t=>{state.isNotStopWhenMovCam=this.isNotStopWhenMovCam.checked},!1),this.syousaisettei5.addEventListener("input",t=>{state.viewSpeed=t.target.value/10},!1),this.syousaisettei6.addEventListener("change",t=>{state.texthidden=!this.syousaisettei6.checked},!1),this.syousaisettei8.addEventListener("change",t=>{state.objectselect=t.target.value,"club"==state.objectselect?state.clubRot.displayInput():state.clubRot.hiddenInput(),"ring"==state.objectselect?state.ringSetting.displayInput():state.ringSetting.hiddenInput(),"ring"==state.objectselect&&0==state.camPosX&&(this.cameraX.value=45,state.camPosX=-.45)},!1),this.inputString.addEventListener("focus",()=>{log.show()}),this.inputString.addEventListener("blur",()=>{log.hide()}),this.cameraX.addEventListener("input",function(t){state.camPosX=-t.target.value/100}),this.cameraX.addEventListener("touchstart",()=>{state.isNotStopWhenMovCam||state.setZeroViewSpeed()}),this.cameraX.addEventListener("touchend",()=>{state.setViewSpeed()}),this.cameraX.addEventListener("mousedown",()=>{state.isNotStopWhenMovCam||state.setZeroViewSpeed()}),this.cameraX.addEventListener("mouseup",()=>{state.setViewSpeed()}),this.cameraX.addEventListener("mouseleave",()=>{state.setViewSpeed()})}}class Log{constructor(){this.logDiv=document.getElementById("log"),this.storageKey="umejugg_SSM_Log",this.timeoutDuration=3e3,this.timeoutId=null}timeStart(t){this.timeClear(),this.timeoutId=setTimeout(()=>{this.add(t),this.timeoutId=null},this.timeoutDuration)}timeClear(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}show(){try{let t=this.get();console.log(t),t&&(this.logDiv.scrollTop=0,this.logDiv.style.maxHeight="200px",this.logDiv.style.opacity="1",this._addLogHtml(t))}catch(e){return console.error("Failed to add data:",e),!1}}hide(){this.logDiv.style.maxHeight="0",this.logDiv.style.opacity="0"}_addLogHtml(t){this.logDiv.innerHTML="",t.reverse().forEach(t=>{let e=document.createElement("a");e.textContent=t,e.addEventListener("click",e=>{e.preventDefault(),eventManager.inputString.value=t,animation.start(t)}),this.logDiv.appendChild(e)});let e=document.createElement("a");e.style.color="#EC407A",e.textContent="履歴を削除",e.addEventListener("click",t=>{t.preventDefault(),this.delete(),this.hide()}),this.logDiv.appendChild(e)}_save(t){try{let e=JSON.stringify(t);return localStorage.setItem(this.storageKey,e),!0}catch(a){return console.error("Failed to save data:",a),!1}}get(){try{let t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):null}catch(e){return console.error("Failed to get data:",e),null}}add(t){try{let e=this.get();e||(e=[]);let a=e[e.length-1];if(a&&JSON.stringify(a)===JSON.stringify(t))return!0;for(;e.length>=20;)e.shift();return e.push(t),this._save(e)}catch(s){return console.error("Failed to add data:",s),!1}}delete(){try{return localStorage.removeItem(this.storageKey),!0}catch(t){return console.error("Failed to delete data:",t),!1}}}class Camera{constructor(){}_rotatePoint(t,e,a,s,i){let n=t-a,r=e-s;return{x:n*Math.cos(i)-r*Math.sin(i)+a,y:n*Math.sin(i)+r*Math.cos(i)+s}}_calculateIntersection(t,e,a,s,i){return s-e==0?(console.error("交点が計算できませんでした"),e===i)?t:null:(-e*a+s*t+(a-t)*i)/(s-e)}projectToScreenX(t,e){let a=state.camPosX*Math.PI/2,s=this._calculateIntersection(t,0,state.centerX,state.camPosZ,e),i=this._rotatePoint(s,e,state.centerX,0,a);return this._calculateIntersection(i.x,i.y,state.centerX,state.camPosZ,0)}getSizeRatio(t){let e=state.camPosX*Math.PI/2,a=this._rotatePoint(t,0,state.centerX,0,e);return 1-a.y/(6*state.centerX)}}const canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),width=canvas.width,height=canvas.height,animation=new Animation,display=new Display,draw=new Draw;let state=new State;const log=new Log,camera=new Camera,eventManager=new EventManager;window.addEventListener("load",()=>{requestAnimationFrame(animation.frame)});