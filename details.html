<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サイトスワップの確認/Siteswap Details</title>
    <meta name="description" content="入力された数列がサイトスワップであるかどうかの確認と詳細情報を表示【サイトスワップマスター】">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&display=swap');
    </style>
    <link rel="stylesheet" href="simulation.css?ver=9.2.1">
    <style>
        /* 詳細ページ専用スタイル */
        .result-section {
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 12px;
            background: #F9F7F7;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 14px;
            color: #666;
        }

        .result-value {
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            color: #112D4E;
            word-break: break-all;
        }

        .result-value.highlight {
            font-size: 24px;
            color: #3F72AF;
        }

        .status-valid {
            color: #2e7d32;
            font-weight: bold;
        }

        .status-invalid {
            color: #d32f2f;
            font-weight: bold;
        }

        /* スピナー */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #DBE2EF;
            border-top-color: #3F72AF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }

        .loading-container.visible {
            display: flex;
        }

        /* シミュレーションコンテナ */
        .simulation-wrapper {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #DBE2EF;
        }

        .simulation-container {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .simulation-container iframe {
            width: 300px;
            aspect-ratio: 3 / 5;
            border: none;
            border-radius: 8px;
        }

        .simulation-link {
            display: block;
            text-align: center;
            padding: 12px;
            background: #3F72AF;
            color: #F9F7F7;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        .simulation-link:hover {
            background: #2E5A8E;
        }

        /* 接続情報 */
        .connection-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #DBE2EF;
        }

        .connection-text {
            font-size: 14px;
            color: #112D4E;
            line-height: 1.8;
            background: #F9F7F7;
            padding: 16px;
            border-radius: 8px;
        }

        .connection-text strong {
            color: #3F72AF;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loader"><p>Loading...</p></div>
        <header id="title-wrapper">
            <a href="home" class="titleText">
                <h1><span>サイトスワップ</span><span>マスター</span></h1>
            </a>
        </header>

        <main>
            <section>
                <h2>サイトスワップの確認</h2>
                <p>入力された数列がどのようなサイトスワップであるかを確認できます。</p>

                <div class="error-display">
                    <output id="er"></output>
                </div>

                <div class="input-container">
                    <label for="patternInput">確認したいサイトスワップ</label>
                    <input type="text" id="patternInput" placeholder="例: 531">
                    <a href="#" class="btn" id="analyzeBtn">確認する</a>
                </div>

                <div class="loading-container" id="loadingContainer">
                    <div class="spinner"></div>
                    <span>解析中...</span>
                </div>

                <div id="resultSection" class="result-section" style="display: none;">
                    <h3 style="color: #3F72AF; margin-bottom: 15px;">解析結果</h3>

                    <div class="result-item">
                        <span class="result-label">入力パターン</span>
                        <span id="resultPattern" class="result-value highlight">-</span>
                    </div>

                    <div class="result-item">
                        <span class="result-label">判定</span>
                        <span id="resultStatus" class="result-value">-</span>
                    </div>

                    <div id="detailsSection" style="display: none;">
                        <h4 style="color: #3F72AF; margin: 20px 0 10px;">詳細情報</h4>

                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>ボール数</label>
                                <span id="resultBallCount" class="result-value">-</span>
                            </div>
                            <div class="setting-item">
                                <label>周期</label>
                                <span id="resultPeriod" class="result-value">-</span>
                            </div>
                            <div class="setting-item">
                                <label>最大値</label>
                                <span id="resultMaxHeight" class="result-value">-</span>
                            </div>
                            <div class="setting-item">
                                <label>パターンタイプ</label>
                                <span id="resultPatternType" class="result-value">-</span>
                            </div>
                        </div>

                        <div class="result-item" style="margin-top: 16px;">
                            <span class="result-label">状態</span>
                            <span id="resultState" class="result-value">-</span>
                        </div>

                        <!-- 基底状態からの接続情報 -->
                        <div class="connection-section" id="connectionSection">
                            <h4 style="color: #3F72AF; margin-bottom: 10px;">基底状態からの接続</h4>
                            <div class="loading-container" id="connectionLoadingContainer">
                                <div class="spinner"></div>
                                <span>計算中...</span>
                            </div>
                            <div id="connectionResult" style="display: none;">
                                <p id="connectionText" class="connection-text"></p>
                            </div>
                        </div>

                        <!-- シミュレーション -->
                        <div class="simulation-wrapper">
                            <h4 style="color: #3F72AF; margin-bottom: 10px;">シミュレーション</h4>
                            <div class="simulation-container">
                                <iframe id="simulationFrame" src="" scrolling="no"></iframe>
                            </div>
                            <a href="#" class="simulation-link" id="simulationLink" target="_blank">シミュレーションページで開く</a>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h2>使い方</h2>
                <p class="info-text">サイトスワップを入力して「確認する」ボタンを押すと、そのパターンが投げられるかどうかを判定し、詳細情報を表示します。</p>
                <p class="info-text">シンクロパターンやマルチプレックスにも対応しています。</p>
            </section>
        </main>

        <footer>
            <a href="home" class="back-home-footer">ホームに戻る</a>
            <a href="https://www.twitter.com/messages/compose?recipient_id=869867240644005889" id="contact" class="contact" aria-label="contact" target="_blank" rel="noopener noreferrer">
                バグを報告
            </a>
            <p>&copy; 2021-2026 サイトスワップマスター</p>
        </footer>
    </div>

    <script>
        window.onload = function() {
            const spinner = document.getElementById('loading');
            spinner.classList.add('loaded');
        }
    </script>
    <script src="siteswapProcessor.js?ver=1.1.3"></script>
    <script src="siteswapLab.js?ver=1.5.0"></script>
    <script>
        // DOM要素
        const patternInput = document.getElementById('patternInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultSection = document.getElementById('resultSection');
        const detailsSection = document.getElementById('detailsSection');
        const errorDisplay = document.getElementById('er');

        // 結果表示要素
        const resultPattern = document.getElementById('resultPattern');
        const resultStatus = document.getElementById('resultStatus');
        const resultBallCount = document.getElementById('resultBallCount');
        const resultPeriod = document.getElementById('resultPeriod');
        const resultMaxHeight = document.getElementById('resultMaxHeight');
        const resultPatternType = document.getElementById('resultPatternType');
        const resultState = document.getElementById('resultState');

        // 接続情報要素
        const connectionSection = document.getElementById('connectionSection');
        const connectionLoadingContainer = document.getElementById('connectionLoadingContainer');
        const connectionResult = document.getElementById('connectionResult');
        const connectionText = document.getElementById('connectionText');

        // シミュレーション要素
        const simulationFrame = document.getElementById('simulationFrame');
        const simulationLink = document.getElementById('simulationLink');

        // 数値をアルファベット表記に変換
        function numToChar(num) {
            if (num < 10) return String(num);
            return String.fromCharCode(87 + num); // a=10, b=11, ...
        }

        // 状態配列を文字列に変換
        function stateToString(state) {
            if (!state || state.length === 0) return '-';
            return '{' + state.map(s => numToChar(s)).join(',') + '}';
        }

        // エラー表示をクリア
        function clearError() {
            errorDisplay.textContent = '';
        }

        // エラー表示
        function showError(message) {
            errorDisplay.textContent = message;
        }

        // 結果セクションを非表示
        function hideResults() {
            resultSection.style.display = 'none';
            detailsSection.style.display = 'none';
        }

        // 解析処理
        function analyze() {
            clearError();
            hideResults();

            const pattern = patternInput.value.trim();

            if (pattern === '') {
                showError('パターンを入力してください。');
                return;
            }

            loadingContainer.classList.add('visible');

            setTimeout(() => {
                try {
                    const result = SiteswapLab.analyzePattern(pattern);

                    loadingContainer.classList.remove('visible');

                    // 入力パターンを表示
                    resultPattern.textContent = pattern;
                    resultSection.style.display = 'block';

                    if (!result.isValid) {
                        resultStatus.textContent = '無効なパターンです';
                        resultStatus.className = 'result-value status-invalid';
                        if (result.message) {
                            showError(result.message);
                        }
                        return;
                    }

                    if (!result.isJugglable) {
                        resultStatus.textContent = 'この数列は投げられません';
                        resultStatus.className = 'result-value status-invalid';
                        return;
                    }

                    // 投げられるパターンの場合
                    resultStatus.textContent = 'この数列は投げられます';
                    resultStatus.className = 'result-value status-valid';

                    const data = result.data;

                    // 詳細情報を表示
                    resultBallCount.textContent = data.propCount + '個';
                    resultPeriod.textContent = data.period;
                    resultMaxHeight.textContent = numToChar(data.maxHeight);
                    resultPatternType.textContent = data.isAsync ? 'アシンクロ' : 'シンクロ';
                    resultState.textContent = stateToString(data.state);

                    detailsSection.style.display = 'block';

                    // シミュレーションを設定
                    const encodedPattern = encodeURIComponent(pattern);
                    simulationFrame.src = `embed?encoded-pattern=${encodedPattern}`;
                    simulationLink.href = `simulation?encoded-pattern=${encodedPattern}`;

                    // 基底状態からの接続を計算
                    calculateConnection(pattern, data.propCount, data.isAsync);

                } catch (e) {
                    loadingContainer.classList.remove('visible');
                    showError('エラー: ' + e.message);
                }
            }, 50);
        }

        // 基底状態からの接続を計算
        function calculateConnection(pattern, propCount, isAsync) {
            connectionLoadingContainer.classList.add('visible');
            connectionResult.style.display = 'none';

            setTimeout(() => {
                try {
                    // 基底状態からの接続を計算（pattern1を空にすると基底状態が補完される）
                    const result = SiteswapLab.calculateConnectionPattern('', pattern);

                    connectionLoadingContainer.classList.remove('visible');

                    if (!result.isValid || !result.isJugglable) {
                        connectionText.innerHTML = '接続の計算に失敗しました。';
                        connectionResult.style.display = 'block';
                        return;
                    }

                    const data = result.data;
                    const groundState = data.pattern1; // 基底状態
                    const entryConnection = data.connection || '';
                    const exitConnection = data.reverseConnection || '';

                    let html = '';

                    if (isAsync) {
                        // アシンクロの場合
                        const basePatternName = propCount % 2 === 0
                            ? `${propCount}ボールファウンテン`
                            : `${propCount}ボールカスケード`;

                        if (entryConnection === '' && exitConnection === '') {
                            html = `このサイトスワップは、<strong>${basePatternName}</strong>から直接入ることができます。`;
                        } else {
                            html = `このサイトスワップは、「<strong>${entryConnection}</strong>」を投げることで<strong>${basePatternName}</strong>から入ることができます。`;
                            if (exitConnection) {
                                html += `<br>また、「<strong>${exitConnection}</strong>」を投げることで<strong>${basePatternName}</strong>に戻ることができます。`;
                            }
                        }
                    } else {
                        // シンクロの場合
                        if (entryConnection === '' && exitConnection === '') {
                            html = `このサイトスワップは、<strong>${groundState}</strong>から直接入ることができます。`;
                        } else {
                            html = `このサイトスワップは、「<strong>${entryConnection}</strong>」を投げることで<strong>${groundState}</strong>から入ることができます。`;
                            if (exitConnection) {
                                html += `<br>また、「<strong>${exitConnection}</strong>」を投げることで<strong>${groundState}</strong>に戻ることができます。`;
                            }
                        }
                    }

                    connectionText.innerHTML = html;
                    connectionResult.style.display = 'block';

                } catch (e) {
                    connectionLoadingContainer.classList.remove('visible');
                    connectionText.innerHTML = '接続の計算中にエラーが発生しました。';
                    connectionResult.style.display = 'block';
                }
            }, 100);
        }

        // イベントリスナー
        analyzeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            analyze();
        });

        // Enterキーで解析
        patternInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyze();
            }
        });

        // URLパラメータから初期値を取得
        const urlParams = new URLSearchParams(window.location.search);
        const initialPattern = urlParams.get('pattern') || urlParams.get('encoded-pattern');
        if (initialPattern) {
            patternInput.value = decodeURIComponent(initialPattern);
            // ページ読み込み後に自動解析
            window.addEventListener('load', function() {
                setTimeout(analyze, 100);
            });
        }
    </script>
</body>
</html>
