<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オリジナルサイトスワップ作成 - サイトスワップマスター</title>
    <meta name="description" content="オリジナルのサイトスワップを作成できる【サイトスワップマスター】">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&display=swap');
    </style>
    <link rel="stylesheet" href="simulation.css?ver=9.3.0">
    <style>
        /* メーカーページ専用スタイル */
        .result-section {
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 12px;
            background: #F9F7F7;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 14px;
            color: #666;
        }

        .result-value {
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            color: #112D4E;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .result-value.highlight {
            font-size: 28px;
            color: #3F72AF;
        }

        /* スピナー */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #DBE2EF;
            border-top-color: #3F72AF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }

        .loading-container.visible {
            display: flex;
        }

        /* 数値選択ボタン */
        .number-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }

        .number-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: #DBE2EF;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #112D4E;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: monospace;
        }

        .number-btn:hover:not(:disabled) {
            background: #3F72AF;
            color: #F9F7F7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(63, 114, 175, 0.3);
        }

        .number-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* 作成中のパターン表示 */
        .pattern-display {
            background: #112D4E;
            color: #F9F7F7;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 16px 0;
        }

        .pattern-display .label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .pattern-display .value {
            font-size: 32px;
            font-family: monospace;
            font-weight: bold;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .pattern-display .cursor {
            animation: blink 1s infinite;
            color: #3F72AF;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 16px 0;
        }

        .btn-secondary {
            display: inline-block;
            padding: 10px 24px;
            background-color: #F9F7F7;
            color: #3F72AF;
            border: 2px solid #3F72AF;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #3F72AF;
            color: #F9F7F7;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-success {
            background-color: #4CAF50;
            color: #F9F7F7;
            border-color: #4CAF50;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #388E3C;
            border-color: #388E3C;
        }

        .btn-danger {
            background-color: #d32f2f;
            color: #F9F7F7;
            border-color: #d32f2f;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #b71c1c;
            border-color: #b71c1c;
        }

        /* 完了情報 */
        .completion-info {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
            border-radius: 10px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .completion-info .message {
            color: #2e7d32;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .completion-info .final-pattern {
            font-family: monospace;
            font-size: 24px;
            font-weight: bold;
            color: #112D4E;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        /* シミュレーションコンテナ */
        .simulation-wrapper {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #DBE2EF;
        }

        .simulation-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            background-color: #5a5a5a;
            border-radius: 8px;
            overflow: hidden;
        }

        .simulation-container iframe {
            width: 100%;
            aspect-ratio: 3 / 5;
            border: none;
            border-radius: 8px;
            display: block;
        }

        .simulation-link {
            display: block;
            text-align: center;
            padding: 12px;
            background: #3F72AF;
            color: #F9F7F7;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        .simulation-link:hover {
            background: #2E5A8E;
        }

        /* ステップ表示 */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            width: 100%;
        }

        .step {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            background: #DBE2EF;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            flex: 0 0 auto;
        }

        @media (max-width: 480px) {
            .step {
                padding: 6px 10px;
                font-size: 12px;
            }

            .step-indicator {
                gap: 4px;
            }
        }

        @media (max-width: 360px) {
            .step {
                padding: 4px 8px;
                font-size: 10px;
            }
        }

        .step.active {
            background: #3F72AF;
            color: #F9F7F7;
        }

        .step.completed {
            background: #4CAF50;
            color: #F9F7F7;
        }

        /* 詳細設定 */
        .advanced-settings {
            margin-top: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .form-group label {
            font-weight: 500;
            color: #112D4E;
        }

        .form-group .hint {
            font-size: 12px;
            color: #666;
            margin-top: -4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="loading" class="loader">
            <p>Loading...</p>
        </div>
        <header id="title-wrapper">
            <a href="home" class="titleText">
                <h1><span>サイトスワップ</span><span>マスター</span></h1>
            </a>
        </header>

        <main>
            <section>
                <h2>オリジナルサイトスワップ作成</h2>
                <p>好きな数値を選んでオリジナルのサイトスワップを作成できます。</p>

                <div class="error-display">
                    <output id="errorOutput"></output>
                </div>

                <!-- ステップ1: ボール数入力 -->
                <div id="step1Section">
                    <div class="step-indicator">
                        <span class="step active">1. ボール数を設定</span>
                        <span class="step">2. パターンを作成</span>
                        <span class="step">3. 完成</span>
                    </div>

                    <div class="input-container">
                        <label for="ballCountInput">ボールの数を指定してください</label>
                        <input type="text" id="ballCountInput" placeholder="0〜35（例: 3）">
                        <span class="hint" style="font-size: 12px; color: #666;">※10以上はa=10, b=11...で入力可能</span>
                    </div>

                    <!-- 詳細設定アコーディオン -->
                    <div class="accordion advanced-settings">
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span>上級者用詳細設定</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div style="padding: 16px;">
                                    <div class="form-group">
                                        <label for="beforePatternInput">直前のサイトスワップ</label>
                                        <input type="text" id="beforePatternInput" placeholder="（省略可）">
                                    </div>
                                    <div class="form-group">
                                        <label for="afterPatternInput">直後のサイトスワップ</label>
                                        <input type="text" id="afterPatternInput" placeholder="（省略可）">
                                        <span class="hint">※前後のサイトスワップの状態が異なる場合、ループ可能にするためには接続パターンが必要になります</span>
                                        <span class="hint">※無記入の場合は基底状態（カスケード/ファウンテン）として作成</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <a href="#" class="btn" id="startBtn" style="margin-top: 20px;">新規作成</a>
                </div>

                <!-- ステップ2: パターン作成 -->
                <div id="step2Section" style="display: none;">
                    <div class="step-indicator">
                        <span class="step completed">1. ボール数を設定</span>
                        <span class="step active">2. パターンを作成</span>
                        <span class="step">3. 完成</span>
                    </div>

                    <!-- リアルタイムシミュレーション（作成中） -->
                    <div class="simulation-wrapper" style="border-top: none; margin-bottom: 20px;">
                        <h4 style="color: #3F72AF; margin-bottom: 10px; text-align: center;">プレビュー</h4>
                        <div class="simulation-container">
                            <iframe id="previewFrame" src="" scrolling="no"></iframe>
                        </div>
                    </div>

                    <div class="pattern-display">
                        <div class="label">作成中のサイトスワップ</div>
                        <div class="value"><span id="currentPattern">_</span><span class="cursor">|</span></div>
                    </div>

                    <div class="result-item">
                        <span class="result-label">追加可能な数値を選択してください</span>
                    </div>

                    <div class="number-buttons" id="numberButtons">
                        <!-- 動的に生成 -->
                    </div>

                    <div class="action-buttons">
                        <button class="btn-secondary btn-danger" id="undoBtn" disabled>一つ削除</button>
                        <button class="btn-secondary btn-success" id="completeBtn">終了して完成</button>
                    </div>

                    <div class="result-item" id="completionHint">
                        <span class="result-label">終了時の追加</span>
                        <span id="completionPattern" class="result-value">-</span>
                    </div>
                </div>

                <!-- ステップ3: 完成 -->
                <div id="step3Section" style="display: none;">
                    <div class="step-indicator">
                        <span class="step completed">1. ボール数を設定</span>
                        <span class="step completed">2. パターンを作成</span>
                        <span class="step completed">3. 完成</span>
                    </div>

                    <!-- 完成シミュレーション -->
                    <div class="simulation-wrapper" style="border-top: none; margin-bottom: 20px;">
                        <h4 style="color: #3F72AF; margin-bottom: 10px; text-align: center;">シミュレーション</h4>
                        <div class="simulation-container">
                            <iframe id="finalFrame" src="" scrolling="no"></iframe>
                        </div>
                        <a href="#" class="simulation-link" id="simulationLink" target="_blank">シミュレーションページで開く</a>
                    </div>

                    <div class="completion-info">
                        <div class="message">オリジナルサイトスワップが完成しました！</div>
                        <div class="final-pattern" id="finalPattern">-</div>
                    </div>

                    <div class="action-buttons">
                        <a href="#" class="btn-secondary" id="newPatternBtn">新しく作成</a>
                    </div>
                </div>
            </section>

            <section>
                <h2>使い方</h2>
                <p class="info-text">1. ボールの数を入力して「新規作成」をクリックします。</p>
                <p class="info-text">2. 選択可能な数値ボタンが表示されるので、好きな数値を順番にクリックしていきます。</p>
                <p class="info-text">3. 「終了して完成」をクリックすると、ループ可能なサイトスワップが完成します。</p>
            </section>
        </main>

        <footer>
            <a href="home" class="back-home-footer">ホームに戻る</a>
            <a href="https://www.twitter.com/messages/compose?recipient_id=869867240644005889" id="contact"
                class="contact" aria-label="contact" target="_blank" rel="noopener noreferrer">
                質問・要望
            </a>
            <p>&copy; 2021-2026 サイトスワップマスター</p>
        </footer>
    </div>

    <script>
        window.onload = function () {
            const spinner = document.getElementById('loading');
            spinner.classList.add('loaded');
        }

        // アコーディオンの動作
        document.querySelectorAll('.accordion-header').forEach(function (header) {
            header.addEventListener('click', function () {
                const accordionItem = this.parentElement;
                accordionItem.classList.toggle('active');
            });
        });
    </script>
    <script src="siteswapProcessor.js?ver=1.1.4"></script>
    <script src="siteswapLab.js?ver=1.5.5"></script>
    <script src="siteswapMaker.js?ver=1.2.0"></script>
    <script>
        // DOM要素
        const ballCountInput = document.getElementById('ballCountInput');
        const beforePatternInput = document.getElementById('beforePatternInput');
        const afterPatternInput = document.getElementById('afterPatternInput');
        const startBtn = document.getElementById('startBtn');
        const errorOutput = document.getElementById('errorOutput');

        const step1Section = document.getElementById('step1Section');
        const step2Section = document.getElementById('step2Section');
        const step3Section = document.getElementById('step3Section');

        const currentPatternEl = document.getElementById('currentPattern');
        const numberButtonsEl = document.getElementById('numberButtons');
        const undoBtn = document.getElementById('undoBtn');
        const completeBtn = document.getElementById('completeBtn');
        const completionPatternEl = document.getElementById('completionPattern');
        const previewFrame = document.getElementById('previewFrame');

        const finalPatternEl = document.getElementById('finalPattern');
        const finalFrame = document.getElementById('finalFrame');
        const simulationLink = document.getElementById('simulationLink');
        const newPatternBtn = document.getElementById('newPatternBtn');

        // SiteswapMakerインスタンス
        let maker = null;

        // エラー表示
        function showError(message) {
            errorOutput.textContent = message;
        }

        function clearError() {
            errorOutput.textContent = '';
        }

        // 数値ボタンを生成
        function renderNumberButtons() {
            numberButtonsEl.innerHTML = '';
            const available = maker.getPossibleThrows();

            for (let i = 0; i <= 35; i++) {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = SiteswapProcessor.CONVERT[i];
                btn.disabled = !available.includes(i);
                btn.addEventListener('click', () => addNumber(i));
                numberButtonsEl.appendChild(btn);
            }
        }

        // 数値を追加
        function addNumber(num) {
            clearError();

            if (!maker.add(num)) {
                showError(maker.error || '追加に失敗しました');
                return;
            }

            // UI更新
            updateUI();
        }

        // 一つ削除
        function undoLast() {
            if (!maker.back()) {
                return;
            }

            updateUI();
        }

        // UI更新
        function updateUI() {
            // パターン表示
            const patternStr = maker.getCurrentPatternString() || '_';
            currentPatternEl.textContent = patternStr;

            // ボタン更新
            renderNumberButtons();

            // 削除ボタン
            undoBtn.disabled = !maker.canBack();

            // 完了時のパターン計算
            const completion = maker.getNeededConnection();
            if (completion === '') {
                completionPatternEl.textContent = '終了ボタンを押すと完成します';
            } else {
                completionPatternEl.textContent = `終了ボタンを押すと「${completion}」が追加されて完成します`;
            }

            // プレビュー更新
            const previewPattern = maker.getCurrentPatternString() + completion;
            if (previewPattern) {
                updateSimulation(previewFrame, previewPattern);
            }
        }

        /**
         * シミュレーターの更新
         */
        function updateSimulation(iframe, pattern) {
            if (!pattern) {
                iframe.src = '';
                return;
            }

            // すでにシミュレーターが読み込まれている場合はメッセージ送信で更新（高速）
            if (iframe.contentWindow && iframe.src && iframe.src !== 'about:blank' && iframe.src !== window.location.href) {
                iframe.contentWindow.postMessage({
                    type: "START_ANIMATION",
                    value: pattern
                }, window.location.origin);
            } else {
                // 初回読み込みや未ロード時はsrcをセット
                const url = new URL(`embed?encoded-pattern=${encodeURIComponent(pattern)}`, window.location.href).href;
                if (iframe.src !== url) {
                    iframe.src = url;
                }
            }
        }


        // 完成
        function complete() {
            const finalPatternStr = maker.finish();

            finalPatternEl.textContent = finalPatternStr;

            // シミュレーション設定
            const encodedPattern = encodeURIComponent(finalPatternStr);
            updateSimulation(finalFrame, finalPatternStr);
            simulationLink.href = `simulation?encoded-pattern=${encodedPattern}`;

            // セクション切り替え
            step2Section.style.display = 'none';
            step3Section.style.display = 'block';
        }


        // 新規作成開始
        function startCreation() {
            clearError();

            // SiteswapMakerインスタンス作成（バリデーションはクラス内で実行）
            maker = new SiteswapMaker(
                ballCountInput.value,
                beforePatternInput.value,
                afterPatternInput.value
            );

            if (maker.error) {
                showError(maker.error);
                return;
            }

            // セクション切り替え
            step1Section.style.display = 'none';
            step2Section.style.display = 'block';

            // シミュレーターの初回読み込み（直前のサイトスワップ、または基底状態）
            // maker.currentState から基底状態を推定、または startPattern を使用
            let initialPattern = maker.startPattern;
            if (!initialPattern || initialPattern.trim() === '') {
                initialPattern = SiteswapProcessor.CONVERT[maker.propCount] || maker.propCount.toString();
            }
            updateSimulation(previewFrame, initialPattern);

            // UI初期化
            updateUI();
        }


        // リセット
        function resetToStart() {
            step1Section.style.display = 'block';
            step2Section.style.display = 'none';
            step3Section.style.display = 'none';

            maker = null;

            updateSimulation(previewFrame, '');
            updateSimulation(finalFrame, '');
            clearError();
        }

        // イベントリスナー
        startBtn.addEventListener('click', function (e) {
            e.preventDefault();
            startCreation();
        });

        undoBtn.addEventListener('click', function (e) {
            e.preventDefault();
            undoLast();
        });

        completeBtn.addEventListener('click', function (e) {
            e.preventDefault();
            complete();
        });

        newPatternBtn.addEventListener('click', function (e) {
            e.preventDefault();
            resetToStart();
        });

        // Enterキーで開始
        ballCountInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                startCreation();
            }
        });
    </script>
</body>

</html>