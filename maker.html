<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オリジナルサイトスワップ作成 - サイトスワップマスター</title>
    <meta name="description" content="オリジナルのサイトスワップを作成できる【サイトスワップマスター】">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&display=swap');
    </style>
    <link rel="stylesheet" href="simulation.css?ver=9.2.1">
    <style>
        /* メーカーページ専用スタイル */
        .result-section {
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 12px;
            background: #F9F7F7;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 14px;
            color: #666;
        }

        .result-value {
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            color: #112D4E;
            word-break: break-all;
        }

        .result-value.highlight {
            font-size: 28px;
            color: #3F72AF;
        }

        /* スピナー */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #DBE2EF;
            border-top-color: #3F72AF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }

        .loading-container.visible {
            display: flex;
        }

        /* 数値選択ボタン */
        .number-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }

        .number-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: #DBE2EF;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #112D4E;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: monospace;
        }

        .number-btn:hover:not(:disabled) {
            background: #3F72AF;
            color: #F9F7F7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(63, 114, 175, 0.3);
        }

        .number-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* 作成中のパターン表示 */
        .pattern-display {
            background: #112D4E;
            color: #F9F7F7;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 16px 0;
        }

        .pattern-display .label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .pattern-display .value {
            font-size: 32px;
            font-family: monospace;
            font-weight: bold;
            word-break: break-all;
        }

        .pattern-display .cursor {
            animation: blink 1s infinite;
            color: #3F72AF;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 16px 0;
        }

        .btn-secondary {
            display: inline-block;
            padding: 10px 24px;
            background-color: #F9F7F7;
            color: #3F72AF;
            border: 2px solid #3F72AF;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #3F72AF;
            color: #F9F7F7;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-success {
            background-color: #4CAF50;
            color: #F9F7F7;
            border-color: #4CAF50;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #388E3C;
            border-color: #388E3C;
        }

        .btn-danger {
            background-color: #d32f2f;
            color: #F9F7F7;
            border-color: #d32f2f;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #b71c1c;
            border-color: #b71c1c;
        }

        /* 完了情報 */
        .completion-info {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
            border-radius: 10px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .completion-info .message {
            color: #2e7d32;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .completion-info .final-pattern {
            font-family: monospace;
            font-size: 24px;
            font-weight: bold;
            color: #112D4E;
        }

        /* シミュレーションコンテナ */
        .simulation-wrapper {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #DBE2EF;
        }

        .simulation-container {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .simulation-container iframe {
            width: 300px;
            aspect-ratio: 3 / 5;
            border: none;
            border-radius: 8px;
        }

        .simulation-link {
            display: block;
            text-align: center;
            padding: 12px;
            background: #3F72AF;
            color: #F9F7F7;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        .simulation-link:hover {
            background: #2E5A8E;
        }

        /* ステップ表示 */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #DBE2EF;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
        }

        .step.active {
            background: #3F72AF;
            color: #F9F7F7;
        }

        .step.completed {
            background: #4CAF50;
            color: #F9F7F7;
        }

        /* 詳細設定 */
        .advanced-settings {
            margin-top: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .form-group label {
            font-weight: 500;
            color: #112D4E;
        }

        .form-group .hint {
            font-size: 12px;
            color: #666;
            margin-top: -4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="loading" class="loader">
            <p>Loading...</p>
        </div>
        <header id="title-wrapper">
            <a href="home" class="titleText">
                <h1><span>サイトスワップ</span><span>マスター</span></h1>
            </a>
        </header>

        <main>
            <section>
                <h2>オリジナルサイトスワップ作成</h2>
                <p>好きな数値を選んでオリジナルのサイトスワップを作成できます。</p>

                <div class="error-display">
                    <output id="errorOutput"></output>
                </div>

                <!-- ステップ1: ボール数入力 -->
                <div id="step1Section">
                    <div class="step-indicator">
                        <span class="step active">1. ボール数を設定</span>
                        <span class="step">2. パターンを作成</span>
                        <span class="step">3. 完成</span>
                    </div>

                    <div class="input-container">
                        <label for="ballCountInput">ボールの数を指定してください</label>
                        <input type="text" id="ballCountInput" placeholder="0〜35（例: 3）">
                        <span class="hint" style="font-size: 12px; color: #666;">※10以上はa=10, b=11...で入力可能</span>
                    </div>

                    <!-- 詳細設定アコーディオン -->
                    <div class="accordion advanced-settings">
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <span>上級者用詳細設定</span>
                                <span class="accordion-icon">▼</span>
                            </div>
                            <div class="accordion-content">
                                <div style="padding: 16px;">
                                    <div class="form-group">
                                        <label for="beforePatternInput">直前のサイトスワップ</label>
                                        <input type="text" id="beforePatternInput" placeholder="（省略可）">
                                        <span class="hint">※無記入の場合は基底状態（カスケード/ファウンテン）として作成</span>
                                    </div>
                                    <div class="form-group">
                                        <label for="afterPatternInput">直後のサイトスワップ</label>
                                        <input type="text" id="afterPatternInput" placeholder="（省略可）">
                                        <span class="hint">※前後のサイトスワップの状態が異なる場合、ループ不可能になることがあります</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <a href="#" class="btn" id="startBtn" style="margin-top: 20px;">新規作成</a>
                </div>

                <!-- ステップ2: パターン作成 -->
                <div id="step2Section" style="display: none;">
                    <div class="step-indicator">
                        <span class="step completed">1. ボール数を設定</span>
                        <span class="step active">2. パターンを作成</span>
                        <span class="step">3. 完成</span>
                    </div>

                    <div class="pattern-display">
                        <div class="label">作成中のサイトスワップ</div>
                        <div class="value"><span id="currentPattern">_</span><span class="cursor">|</span></div>
                    </div>

                    <div class="result-item">
                        <span class="result-label">追加可能な数値を選択してください</span>
                    </div>

                    <div class="number-buttons" id="numberButtons">
                        <!-- 動的に生成 -->
                    </div>

                    <div class="action-buttons">
                        <button class="btn-secondary btn-danger" id="undoBtn" disabled>一つ削除</button>
                        <button class="btn-secondary btn-success" id="completeBtn">終了して完成</button>
                    </div>

                    <div class="result-item" id="completionHint">
                        <span class="result-label">終了時の追加</span>
                        <span id="completionPattern" class="result-value">-</span>
                    </div>

                    <!-- リアルタイムシミュレーション -->
                    <div class="simulation-wrapper">
                        <h4 style="color: #3F72AF; margin-bottom: 10px;">プレビュー</h4>
                        <div class="simulation-container">
                            <iframe id="previewFrame" src="" scrolling="no"></iframe>
                        </div>
                    </div>
                </div>

                <!-- ステップ3: 完成 -->
                <div id="step3Section" style="display: none;">
                    <div class="step-indicator">
                        <span class="step completed">1. ボール数を設定</span>
                        <span class="step completed">2. パターンを作成</span>
                        <span class="step completed">3. 完成</span>
                    </div>

                    <div class="completion-info">
                        <div class="message">オリジナルサイトスワップが完成しました！</div>
                        <div class="final-pattern" id="finalPattern">-</div>
                    </div>

                    <div class="action-buttons">
                        <a href="#" class="btn-secondary" id="newPatternBtn">新しく作成</a>
                    </div>

                    <!-- 完成シミュレーション -->
                    <div class="simulation-wrapper">
                        <h4 style="color: #3F72AF; margin-bottom: 10px;">シミュレーション</h4>
                        <div class="simulation-container">
                            <iframe id="finalFrame" src="" scrolling="no"></iframe>
                        </div>
                        <a href="#" class="simulation-link" id="simulationLink" target="_blank">シミュレーションページで開く</a>
                    </div>
                </div>
            </section>

            <section>
                <h2>使い方</h2>
                <p class="info-text">1. ボールの数を入力して「新規作成」をクリックします。</p>
                <p class="info-text">2. 選択可能な数値ボタンが表示されるので、好きな数値を順番にクリックしていきます。</p>
                <p class="info-text">3. 「終了して完成」をクリックすると、ループ可能なサイトスワップが完成します。</p>
            </section>
        </main>

        <footer>
            <a href="home" class="back-home-footer">ホームに戻る</a>
            <a href="https://www.twitter.com/messages/compose?recipient_id=869867240644005889" id="contact"
                class="contact" aria-label="contact" target="_blank" rel="noopener noreferrer">
                質問・要望
            </a>
            <p>&copy; 2021-2026 サイトスワップマスター</p>
        </footer>
    </div>

    <script>
        window.onload = function () {
            const spinner = document.getElementById('loading');
            spinner.classList.add('loaded');
        }

        // アコーディオンの動作
        document.querySelectorAll('.accordion-header').forEach(function (header) {
            header.addEventListener('click', function () {
                const accordionItem = this.parentElement;
                accordionItem.classList.toggle('active');
            });
        });
    </script>
    <script src="siteswapProcessor.js?ver=1.1.4"></script>
    <script src="siteswapLab.js?ver=1.5.4"></script>
    <script src="siteswapMaker.js?ver=1.0.0"></script>
    <script>
        // 数値変換マップ
        const CONVERT_TO_NUM = {
            '0': 0, '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9,
            'a': 10, 'b': 11, 'c': 12, 'd': 13, 'e': 14, 'f': 15, 'g': 16, 'h': 17, 'i': 18, 'j': 19,
            'k': 20, 'l': 21, 'm': 22, 'n': 23, 'o': 24, 'p': 25, 'q': 26, 'r': 27, 's': 28, 't': 29,
            'u': 30, 'v': 31, 'w': 32, 'x': 33, 'y': 34, 'z': 35,
            'A': 10, 'B': 11, 'C': 12, 'D': 13, 'E': 14, 'F': 15, 'G': 16, 'H': 17, 'I': 18, 'J': 19,
            'K': 20, 'L': 21, 'M': 22, 'N': 23, 'O': 24, 'P': 25, 'Q': 26, 'R': 27, 'S': 28, 'T': 29,
            'U': 30, 'V': 31, 'W': 32, 'X': 33, 'Y': 34, 'Z': 35
        };

        const CONVERT_TO_CHAR = {
            0: '0', 1: '1', 2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 8: '8', 9: '9',
            10: 'a', 11: 'b', 12: 'c', 13: 'd', 14: 'e', 15: 'f', 16: 'g', 17: 'h', 18: 'i', 19: 'j',
            20: 'k', 21: 'l', 22: 'm', 23: 'n', 24: 'o', 25: 'p', 26: 'q', 27: 'r', 28: 's', 29: 't',
            30: 'u', 31: 'v', 32: 'w', 33: 'x', 34: 'y', 35: 'z'
        };

        // DOM要素
        const ballCountInput = document.getElementById('ballCountInput');
        const beforePatternInput = document.getElementById('beforePatternInput');
        const afterPatternInput = document.getElementById('afterPatternInput');
        const startBtn = document.getElementById('startBtn');
        const errorOutput = document.getElementById('errorOutput');

        const step1Section = document.getElementById('step1Section');
        const step2Section = document.getElementById('step2Section');
        const step3Section = document.getElementById('step3Section');

        const currentPatternEl = document.getElementById('currentPattern');
        const numberButtonsEl = document.getElementById('numberButtons');
        const undoBtn = document.getElementById('undoBtn');
        const completeBtn = document.getElementById('completeBtn');
        const completionPatternEl = document.getElementById('completionPattern');
        const previewFrame = document.getElementById('previewFrame');

        const finalPatternEl = document.getElementById('finalPattern');
        const finalFrame = document.getElementById('finalFrame');
        const simulationLink = document.getElementById('simulationLink');
        const newPatternBtn = document.getElementById('newPatternBtn');

        // 状態管理
        let ballCount = 0;
        let beforePattern = '';
        let afterPattern = '';
        let currentState = [];
        let targetState = [];
        let patternArray = [];
        let history = [];

        // エラー表示
        function showError(message) {
            errorOutput.textContent = message;
        }

        function clearError() {
            errorOutput.textContent = '';
        }

        // 入力文字を数値に変換
        function charToNum(char) {
            if (CONVERT_TO_NUM.hasOwnProperty(char)) {
                return CONVERT_TO_NUM[char];
            }
            return parseInt(char);
        }

        // 数値を文字に変換
        function numToChar(num) {
            return CONVERT_TO_CHAR[num] || num.toString();
        }

        // 状態計算（基底状態）
        function getGroundState(balls) {
            const state = [];
            for (let i = 0; i < balls; i++) {
                state.push(i);
            }
            return state;
        }

        // パターンの状態を計算
        function calculatePatternState(patternStr, balls) {
            if (!patternStr || patternStr.trim() === '') {
                return getGroundState(balls);
            }

            // SiteswapLabを使用して状態を計算
            try {
                const result = SiteswapLab.analyzePattern(patternStr);
                if (result.isValid && result.isJugglable && result.data) {
                    return result.data.state;
                }
            } catch (e) {
                console.error('State calculation error:', e);
            }

            return getGroundState(balls);
        }

        // 次に投げられる数値リストを計算
        function getAvailableNumbers(state) {
            const available = [];
            for (let i = 0; i < 36; i++) {
                if (!state.includes(i)) {
                    available.push(i);
                }
            }
            return available;
        }

        // 状態を更新（数値を投げた後）
        function updateState(state, throwValue) {
            // 0を投げた場合は何も起きない（手持ち）
            // それ以外は着地時刻を追加
            const newState = state.map(s => s - 1).filter(s => s >= 0);
            if (throwValue > 0) {
                newState.push(throwValue - 1);
            }
            newState.sort((a, b) => a - b);
            return newState;
        }

        // 完了時に追加が必要なパターンを計算
        function calculateCompletionPattern(currentState, targetState) {
            // 現在の状態からターゲット状態への接続を計算
            // SiteswapLabの接続計算ロジックを簡略化
            let fromState = [...currentState];
            let toState = [...targetState];

            const connection = [];
            let iteration = 0;
            const maxFromState = fromState.length > 0 ? Math.max(...fromState) : 0;

            while (iteration <= maxFromState + 10) {
                const fromPositives = fromState.filter(v => v >= 0);

                // 部分集合チェック
                let isSubset = true;
                const toStateCopy = [...toState];
                for (const val of fromPositives) {
                    const idx = toStateCopy.indexOf(val);
                    if (idx === -1) {
                        isSubset = false;
                        break;
                    }
                    toStateCopy.splice(idx, 1);
                }

                if (isSubset) {
                    // 差分から接続投げを計算
                    const diff = toState.filter(v => !fromPositives.includes(v));
                    const totalBeats = connection.length;

                    for (let i = 0; i < diff.length; i++) {
                        const throwValue = diff[i] + (diff.length - i);
                        connection.push(throwValue);
                    }
                    break;
                }

                // 状態をデクリメント
                const minusOneCount = fromState.filter(v => v === 0).length;
                fromState = fromState.map(v => v - 1);

                // 投げる値を決定（仮: 最小の正の差分値）
                const availableThrows = [];
                for (let i = 0; i < 36; i++) {
                    const throwHeight = i;
                    const landing = throwHeight - 1;
                    if (landing >= 0 && !fromState.includes(landing)) {
                        availableThrows.push(throwHeight);
                    }
                }

                if (availableThrows.length > 0) {
                    // とりあえず平均に近い値を選択
                    const avgThrow = ballCount;
                    const closest = availableThrows.reduce((prev, curr) =>
                        Math.abs(curr - avgThrow) < Math.abs(prev - avgThrow) ? curr : prev
                    );
                    connection.push(closest);
                }

                iteration++;
            }

            return connection.map(numToChar).join('');
        }

        // 数値ボタンを生成
        function renderNumberButtons() {
            numberButtonsEl.innerHTML = '';
            const available = getAvailableNumbers(currentState);

            for (let i = 0; i <= 35; i++) {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = numToChar(i);
                btn.disabled = !available.includes(i);
                btn.addEventListener('click', () => addNumber(i));
                numberButtonsEl.appendChild(btn);
            }
        }

        // 数値を追加
        function addNumber(num) {
            clearError();

            // 履歴に保存
            history.push({
                state: [...currentState],
                pattern: [...patternArray]
            });

            // パターンに追加
            patternArray.push(num);

            // 状態を更新
            currentState = updateState(currentState, num);

            // UI更新
            updateUI();
        }

        // 一つ削除
        function undoLast() {
            if (history.length === 0) return;

            const prev = history.pop();
            currentState = prev.state;
            patternArray = prev.pattern;

            updateUI();
        }

        // UI更新
        function updateUI() {
            // パターン表示
            const patternStr = patternArray.length > 0
                ? patternArray.map(numToChar).join('')
                : '_';
            currentPatternEl.textContent = patternStr;

            // ボタン更新
            renderNumberButtons();

            // 削除ボタン
            undoBtn.disabled = history.length === 0;

            // 完了時のパターン計算
            const completion = calculateCompletionPattern(currentState, targetState);
            if (completion === '') {
                completionPatternEl.textContent = '終了ボタンを押すと完成します';
            } else {
                completionPatternEl.textContent = `終了ボタンを押すと「${completion}」が追加されて完成します`;
            }

            // プレビュー更新
            const previewPattern = patternArray.map(numToChar).join('') + completion;
            if (previewPattern) {
                previewFrame.src = `embed?encoded-pattern=${encodeURIComponent(previewPattern)}`;
            }
        }

        // 完成
        function complete() {
            const completion = calculateCompletionPattern(currentState, targetState);
            const finalPatternStr = patternArray.map(numToChar).join('') + completion;

            finalPatternEl.textContent = finalPatternStr;

            // シミュレーション設定
            const encodedPattern = encodeURIComponent(finalPatternStr);
            finalFrame.src = `embed?encoded-pattern=${encodedPattern}`;
            simulationLink.href = `simulation?encoded-pattern=${encodedPattern}`;

            // セクション切り替え
            step2Section.style.display = 'none';
            step3Section.style.display = 'block';
        }

        // 新規作成開始
        function startCreation() {
            clearError();

            // 入力値の検証
            const ballInput = ballCountInput.value.trim();
            if (ballInput === '') {
                showError('ボールの数を入力してください');
                return;
            }

            // 数値変換
            let balls;
            if (CONVERT_TO_NUM.hasOwnProperty(ballInput)) {
                balls = CONVERT_TO_NUM[ballInput];
            } else {
                balls = parseInt(ballInput);
            }

            if (isNaN(balls) || balls < 0 || balls > 35) {
                showError('ボールの数は0〜35の範囲で入力してください');
                return;
            }

            // 前後のパターン検証
            const before = beforePatternInput.value.trim();
            const after = afterPatternInput.value.trim();

            if (before !== '') {
                const result = SiteswapLab.validatePattern(before);
                if (!result.isValid || !result.isJugglable) {
                    showError('直前のサイトスワップが無効です: ' + (result.message || ''));
                    return;
                }
                const analysis = SiteswapLab.analyzePattern(before);
                if (analysis.data && analysis.data.propCount !== balls) {
                    showError(`直前のサイトスワップのボール数(${analysis.data.propCount})が指定と異なります`);
                    return;
                }
            }

            if (after !== '') {
                const result = SiteswapLab.validatePattern(after);
                if (!result.isValid || !result.isJugglable) {
                    showError('直後のサイトスワップが無効です: ' + (result.message || ''));
                    return;
                }
                const analysis = SiteswapLab.analyzePattern(after);
                if (analysis.data && analysis.data.propCount !== balls) {
                    showError(`直後のサイトスワップのボール数(${analysis.data.propCount})が指定と異なります`);
                    return;
                }
            }

            // 初期化
            ballCount = balls;
            beforePattern = before;
            afterPattern = after;

            currentState = calculatePatternState(before, balls);
            targetState = calculatePatternState(after, balls);
            patternArray = [];
            history = [];

            // セクション切り替え
            step1Section.style.display = 'none';
            step2Section.style.display = 'block';

            // UI初期化
            updateUI();
        }

        // リセット
        function resetToStart() {
            step1Section.style.display = 'block';
            step2Section.style.display = 'none';
            step3Section.style.display = 'none';

            ballCount = 0;
            beforePattern = '';
            afterPattern = '';
            currentState = [];
            targetState = [];
            patternArray = [];
            history = [];

            previewFrame.src = '';
            finalFrame.src = '';
            clearError();
        }

        // イベントリスナー
        startBtn.addEventListener('click', function (e) {
            e.preventDefault();
            startCreation();
        });

        undoBtn.addEventListener('click', function (e) {
            e.preventDefault();
            undoLast();
        });

        completeBtn.addEventListener('click', function (e) {
            e.preventDefault();
            complete();
        });

        newPatternBtn.addEventListener('click', function (e) {
            e.preventDefault();
            resetToStart();
        });

        // Enterキーで開始
        ballCountInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                startCreation();
            }
        });
    </script>
</body>

</html>